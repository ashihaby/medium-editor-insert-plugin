/*!
 * medium-editor-insert-plugin v0.1.1 - jQuery insert plugin for MediumEditor
 *
 * Images Addon
 *
 * https://github.com/orthes/medium-editor-images-plugin
 *
 * Copyright (c) 2013 Pavel Linkesch (http://linkesch.sk)
 * Released under the MIT license
 */
!function(a){a.fn.mediumInsert.registerAddon("images",{init:function(b){b&&b.$el&&(this.$el=b.$el),this.options=a.extend(this.default,b),this.setImageEvents(),this.options.dragAndDrop&&this.setDragAndDropEvents(),this.preparePreviousImages()},insertButton:function(a){var b="Img";return"fontawesome"===a&&(b='<i class="fa fa-picture-o"></i>'),'<button data-addon="images" data-action="add" class="medium-editor-action medium-editor-action-image mediumInsert-action">'+b+"</button>"},"default":{imagesUploadScript:"upload.php",uploadErrorCallback:a.noop,uploadSuccessCallback:a.noop,uploadCompleteCallback:a.noop,unsupportedFileTypeCallback:a.noop,dragAndDrop:!0,formatData:function(a){var b=new FormData;return b.append("file",a),b}},preparePreviousImages:function(){var b=this;this.$el.find(".mediumInsert-images").each(function(){var c=a(this).parent();c.html('<div class="mediumInsert-placeholder" draggable="'+b.options.dragAndDrop+'">'+c.html()+"</div>")})},add:function(b,c){var d,e,f=this;return d=a('<input type="file">').click(),d.change(function(){e=this.files,f.uploadFiles(c,e,f)}),a.fn.mediumInsert.insert.deselect(),d},updateProgressBar:function(b){var c,d=a(".progress:first",this.$el);b.lengthComputable&&(c=b.loaded/b.total*100|0,d.attr("value",c),d.html(c))},uploadCompleted:function(b){var c,d=a(".progress:first",this.$el);d.attr("value",100),d.html(100),c=d.siblings(".uploading").find("img"),d.remove(),c.css("opacity",1),d.siblings(".uploading").removeClass("uploading"),this.options.uploadCompleteCallback(b),a.fn.mediumInsert.insert.$el.keyup()},uploadFiles:function(b,c,d){function e(a){j.before('<div class="uploading mediumInsert-images"><img style="opacity: 0.8;width:100%" data-attachment="" src="'+a.target.result+'" draggable="true" alt=""></div>')}for(var f={"image/png":!0,"image/jpeg":!0,"image/gif":!0},g=function(){var a=new XMLHttpRequest;return a.upload.onprogress=d.updateProgressBar,a},h=0;h<c.length;h++){var i=c[h];if(f[i.type]===!0){b.append('<progress style="display:none" class="progress" min="0" max="100" value="0">0</progress>');var j=a(".progress:first",this.$el);j.parent().parent().after("<p><br/></p>");var k=new FileReader;a(k).on("load",e),k.readAsDataURL(i),uploadPromise=a.ajax({type:"post",url:a.fn.mediumInsert.settings.addons.images.imagesUploadScript,xhr:g,cache:!1,contentType:!1,context:this,complete:function(a){d.uploadCompleted(a,b)},success:function(a){data=this.options.format(a),$img=j.siblings(".uploading").find("img"),$img.attr("src",data.imageSrc),$img.attr("data-attachment",data.attachmentId),this.setImageEvents(),$img.load(function(){$img.parent().mouseleave().mouseenter()}),d.options.uploadSuccessCallback(a)},error:function(a){d.options.uploadErrorCallback(a,b),$img=j.siblings(".uploading").find("img"),$img.detach()},processData:!1,data:this.options.formatData(i)}),d.options.onStartUpload(uploadPromise)}else d.options.unsupportedFileTypeCallback()}},setImageEvents:function(){this.$el.on("mouseenter",".mediumInsert-images",function(){var b,c,d=a("img",this);a.fn.mediumInsert.settings.enabled!==!1&&d.length>0&&(a(this).append('<a class="mediumInsert-imageRemove"></a>'),b=d.position().top+parseInt(d.css("margin-top"),10),c=d.position().left+d.width()-30,a(".mediumInsert-imageRemove",this).css({right:"auto",top:b,left:c}))}),this.$el.on("mouseleave",".mediumInsert-images",function(){a(".mediumInsert-imageRemove, .mediumInsert-imageResizeSmaller, .mediumInsert-imageResizeBigger",this).remove()}),this.$el.on("click",".mediumInsert-imageResizeSmaller",function(){a(this).parent().parent().parent().addClass("small"),a(this).parent().mouseleave().mouseleave(),a.fn.mediumInsert.insert.deselect()}),this.$el.on("click",".mediumInsert-imageResizeBigger",function(){a(this).parent().parent().parent().removeClass("small"),a(this).parent().mouseleave().mouseleave(),a.fn.mediumInsert.insert.deselect()}),this.$el.on("click",".mediumInsert-imageRemove",function(){a.fn.mediumInsert.settings.addons.images.onRemove(this),0===a(this).parent().siblings().length&&a(this).parent().parent().parent().removeClass("small"),a(this).parent().remove(),a.fn.mediumInsert.insert.deselect()})},setDragAndDropEvents:function(){var b,c,d=this,e=!1,f=!1;a(document).on("dragover","body",function(){a.fn.mediumInsert.settings.enabled!==!1&&a(this).addClass("hover")}),a(document).on("dragend","body",function(){a.fn.mediumInsert.settings.enabled!==!1&&a(this).removeClass("hover")}),this.$el.on("dragover",".mediumInsert",function(){a.fn.mediumInsert.settings.enabled!==!1&&(a(this).addClass("hover"),a(this).attr("contenteditable",!0))}),this.$el.on("dragleave",".mediumInsert",function(){a.fn.mediumInsert.settings.enabled!==!1&&(a(this).removeClass("hover"),a(this).attr("contenteditable",!1))}),this.$el.on("dragstart",".mediumInsert .mediumInsert-images img",function(){a.fn.mediumInsert.settings.enabled!==!1&&(b=a(this).parent().index(),c=a(this).parent().parent().parent().attr("id"))}),this.$el.on("dragend",".mediumInsert .mediumInsert-images img",function(b){a.fn.mediumInsert.settings.enabled!==!1&&e===!0&&(0===a(b.originalEvent.target.parentNode).siblings().length&&a(b.originalEvent.target.parentNode).parent().parent().removeClass("small"),a(b.originalEvent.target.parentNode).mouseleave(),a(b.originalEvent.target.parentNode).remove(),e=!1,f=!1)}),this.$el.on("dragover",".mediumInsert .mediumInsert-images img",function(b){a.fn.mediumInsert.settings.enabled!==!1&&b.preventDefault()}),this.$el.on("drop",".mediumInsert .mediumInsert-images img",function(){var d,e,g;if(a.fn.mediumInsert.settings.enabled!==!1){if(c!==a(this).parent().parent().parent().attr("id"))return f=!1,void(b=c=null);d=parseInt(b,10),e=a(this).parent().parent().find(".mediumInsert-images:nth-child("+(d+1)+")"),g=a(this).parent().index(),g>d?e.insertAfter(a(this).parent()):d>g&&e.insertBefore(a(this).parent()),e.mouseleave(),f=!0,b=null}}),this.$el.on("drop",".mediumInsert",function(b){var c;b.preventDefault(),a.fn.mediumInsert.settings.enabled!==!1&&(a(this).removeClass("hover"),a("body").removeClass("hover"),a(this).attr("contenteditable",!1),c=b.originalEvent.dataTransfer.files,c.length>0?d.uploadFiles(a(".mediumInsert-placeholder",this),c,d):f===!0?f=!1:(a(".mediumInsert-placeholder",this).append('<div class="mediumInsert-images">'+b.originalEvent.dataTransfer.getData("text/html")+"</div>"),a("meta",this).remove(),e=!0))})}})}(jQuery);