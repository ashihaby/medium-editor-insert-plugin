/*! 
 * medium-editor-insert-plugin v0.2.1 - jQuery insert plugin for MediumEditor
 *
 * https://github.com/orthes/medium-editor-images-plugin
 * 
 * Copyright (c) 2014 Pavel Linkesch (http://linkesch.sk)
 * Released under the MIT license
 */

!function(a){var b={};checkScrollBar=function(){var b=a("body").height(),c=a(window).height();return b>c?!0:!1},MediumEditor.prototype.serialize=function(){var b,c,d,e,f,g,h,i,j={};for(b=0;b<this.elements.length;b+=1){for(d=""!==this.elements[b].id?this.elements[b].id:"element-"+b,e=a(this.elements[b]).clone(),f=a(".mediumInsert",e),c=0;c<f.length;c++)g=a(f[c]),h=a(".mediumInsert-placeholder",g).children(),0===h.length?g.remove():(g.removeAttr("contenteditable"),a("img[draggable]",g).removeAttr("draggable"),g.hasClass("small")&&h.addClass("small"),a(".mediumInsert-buttons",g).remove(),h.unwrap());i=e.html().trim(),j[d]={value:i}}return j},MediumEditor.prototype.deactivate=function(){this.deactivateTextEditor(),a.fn.mediumInsert.insert.$el.mediumInsert("disable")},MediumEditor.prototype.deactivateTextEditor=function(){var a;if(!this.isActive)return!1;for(this.isActive=!1,void 0!==this.toolbar&&(this.toolbar.style.display="none"),document.documentElement.removeEventListener("mouseup",this.checkSelectionWrapper),a=0;a<this.elements.length;a+=1)this.elements[a].removeEventListener("paste",this.pasteWrapper),this.elements[a].removeEventListener("keyup",this.checkSelectionWrapper),this.elements[a].removeEventListener("blur",this.checkSelectionWrapper),this.elements[a].removeAttribute("contentEditable")},MediumEditor.prototype.activate=function(){var b;if(this.isActive)return!1;for(void 0!==this.toolbar&&(this.toolbar.style.display="block"),this.isActive=!0,b=0;b<this.elements.length;b+=1)this.elements[b].setAttribute("contentEditable",!0),this.elements[b].addEventListener("paste",this.pasteWrapper);this.bindSelect(),a.fn.mediumInsert.insert.$el.mediumInsert("enable")},a.fn.mediumInsert=function(c){return"string"==typeof c&&a.fn.mediumInsert.insert[c]?void a.fn.mediumInsert.insert[c]():(a.fn.mediumInsert.settings=a.extend(a.fn.mediumInsert.settings,c),this.each(function(){a("p",this).bind("dragover drop",function(a){return a.preventDefault(),!1}),a.fn.mediumInsert.insert.init(a(this));for(var c in a.fn.mediumInsert.settings.addons){var d=a.fn.mediumInsert.settings.addons[c];d.$el=a.fn.mediumInsert.insert.$el,b[c].init(d)}}))},a.fn.mediumInsert.settings={enabled:!0,addons:{images:{},embed:{}}},a.fn.mediumInsert.registerAddon=function(a,c){b[a]=c},a.fn.mediumInsert.getAddon=function(a){return b[a]},a.fn.mediumInsert.insert={init:function(a){this.$el=a,this.isFirefox=navigator.userAgent.match(/firefox/i),this.setPlaceholders(),this.setEvents()},deselect:function(){document.getSelection().removeAllRanges()},disable:function(){a.fn.mediumInsert.settings.enabled=!1,a.fn.mediumInsert.insert.$el.find(".mediumInsert-buttons").addClass("hide")},enable:function(){a.fn.mediumInsert.settings.enabled=!0,a.fn.mediumInsert.insert.$el.find(".mediumInsert-buttons").removeClass("hide")},getMaxId:function(){var b=-1;return a('div[id^="mediumInsert-"]').each(function(){var c=parseInt(a(this).attr("id").split("-")[1],10);c>b&&(b=c)}),b},setPlaceholders:function(){var c=this,d=a.fn.mediumInsert.insert.$el,e=a.fn.mediumInsert.settings.editor,f=e&&e.options?e.options.buttonLabels:"",g='<ul class="mediumInsert-buttonsOptions medium-editor-toolbar medium-editor-toolbar-active">';if(0===Object.keys(a.fn.mediumInsert.settings.addons).length)return!1;for(var h in a.fn.mediumInsert.settings.addons)g+="<li>"+b[h].insertButton(f)+"</li>";g+="</ul>",g='<div class="mediumInsert" contenteditable="false"><div class="mediumInsert-buttons"><a class="mediumInsert-buttonsShow">+</a>'+g+'</div><div class="mediumInsert-placeholder"></div></div>',d.is(":empty")&&d.html("<p><br></p>"),d.keyup(function(){var b,e=d.children(":last");a(".mediumInsert-placeholder").attr("contenteditable",!1),(""===d.html()||"<br>"===d.html())&&d.html("<p><br></p>"),e.hasClass("mediumInsert")&&e.find(".mediumInsert-placeholder").children().length>0&&d.append("<p><br></p>"),this.isFirefox&&a(".mediumInsert .mediumInsert-placeholder:empty",d).each(function(){a(this).parent().remove()}),b=c.getMaxId()+1,d.children("p").each(function(){a(this).next().hasClass("mediumInsert")===!1&&(a(this).after(g),a(this).next(".mediumInsert").attr("id","mediumInsert-"+b)),b++})}).keyup()},hideMediumInput:function(){var c=a.fn.mediumInsert.insert.$el.find(".mediumInsert-embed"),d=a(".mediumInsert-buttons a.mediumInsert-buttonsShow"),e=d.siblings(".mediumInsert-buttonsOptions");c.detach(),b.embed&&b.embed.cancel(),a.fn.mediumInsert.settings.editor.activate(),d.hasClass("active")&&(d.removeClass("active"),e.hide())},setEvents:function(){{var c=this,d=a.fn.mediumInsert.insert.$el,e=a(".mediumInsert-buttons a.mediumInsert-buttonsShow"),f=e.siblings(".mediumInsert-buttonsOptions");e.parent().siblings(".mediumInsert-placeholder")}d.on("selectstart",".mediumInsert",function(a){return a.preventDefault(),!1}),d.on("blur",function(){var b,c=a(this).clone();c.find(".mediumInsert").remove(),b=c.html().replace(/^\s+|\s+$/g,""),(""===b||"<p><br></p>"===b)&&a(this).addClass("medium-editor-placeholder")}),a(document.body).on("click",c.hideMediumInput),d.on("keypress",function(b){if(0!==a(".mediumInsert-buttonsShow.active").length&&(e.removeClass("active"),f.hide()),c.isFirefox&&13===b.keyCode){d.contents().each(function(){return function(a,b){return"#text"===b.nodeName?(document.execCommand("insertHTML",!1,"<p>"+b.data+"</p>"),b.remove()):void 0}}(this));var g=d.find("p").last();g.text().length>0&&g.find("br").remove()}}),d.on("keydown",function(b){return 8===b.keyCode&&a(".mediumInsert-placeholder").attr("contenteditable",!0),navigator.userAgent.match(/chrome/i)&&(d.children().last().removeClass("hide"),(b.ctrlKey||b.metaKey)&&65===b.which)?(b.preventDefault(),0!==d.find("p").length&&0===d.find("p").text().trim().length?!1:(d.children().last().addClass("hide"),document.execCommand("selectAll",!1,null))):void 0}),d.on("click",".mediumInsert-buttons a.mediumInsert-buttonsShow",function(b){b.stopPropagation(),checkScrollBar()&&a(b.currentTarget).parent().parent().position().top>a(window).height()&&window.scroll(0,window.scrollY+50);var d=a(this).siblings(".mediumInsert-buttonsOptions"),e=a(this).parent().siblings(".mediumInsert-placeholder"),f=a.fn.mediumInsert.insert.$el.find(".mediumInsert-embed"),g=a(".mediumInsert-buttons a.mediumInsert-buttonsShow.active");g&&(g.parent().find("ul").hide(),g.removeClass("active")),a(this).hasClass("active")?(a(this).removeClass("active"),d.hide(),a("a",d).show()):(a(this).addClass("active"),d.show(),a("a",d).each(function(){var b=a(this).attr("class").split("action-")[1],c=b.split("-")[0];console.log(b),a(".mediumInsert-"+c,e).length>0&&a("a:not(.action-"+b+")",d).hide()})),f.length>0&&(f.detach(),a(this).addClass("active"),d.show()),c.deselect()}),d.on("click",".medium-editor-action-embed",function(){a(".mediumInsert-buttonsOptions").hide()}),d.on("click",".mediumInsert-buttons .mediumInsert-action",function(c){var d=a(this).data("addon"),e=a(this).data("action"),f=a(this).parents(".mediumInsert-buttons").siblings(".mediumInsert-placeholder");b[d]&&b[d][e]&&b[d][e](c,f),a(this).parents(".mediumInsert").mouseleave()}),d.on("mousemove","p",function(b){a(b.currentTarget).next().find(".mediumInsert-buttonsShow").addClass("active")}),d.on("click","p",function(b){a(b.currentTarget).next().find(".mediumInsert-buttonsShow").addClass("active")}),d.on("mousemove",function(){innerText=d.text().replace(/[+]/gi,"").length,pCounters=d.find("p").length,0===innerText&&1===pCounters&&d.find(".mediumInsert").first().find(".mediumInsert-buttonsShow").addClass("active")}),d.on("mouseleave",function(){innerText=d.text().replace(/[+]/gi,"").length,pCounters=d.find("p").length,0===innerText&&1===pCounters&&(c.hideMediumInput(),d.find(".mediumInsert").first().find(".mediumInsert-buttonsShow").removeClass("active"),f.hide())}),d.on("mouseleave","p",function(b){c.hideMediumInput(),a(b.currentTarget).next().find(".mediumInsert-buttonsShow").removeClass("active"),f.hide()})}}}(jQuery),function(a){a.fn.mediumInsert.registerAddon("images",{init:function(b){b&&b.$el&&(this.$el=b.$el),this.options=a.extend(this.default,b),this.setImageEvents(),this.options.dragAndDrop&&this.setDragAndDropEvents(),this.preparePreviousImages()},insertButton:function(a){var b="Img";return"fontawesome"===a&&(b='<i class="fa fa-picture-o"></i>'),'<button data-addon="images" data-action="add" class="medium-editor-action medium-editor-action-image mediumInsert-action">'+b+"</button>"},"default":{imagesUploadScript:"upload.php",uploadErrorCallback:a.noop,uploadSuccessCallback:a.noop,uploadCompleteCallback:a.noop,unsupportedFileTypeCallback:a.noop,acceptedTypes:{"image/png":!0,"image/jpeg":!0,"image/gif":!0},dragAndDrop:!0,formatData:function(a){var b=new FormData;return b.append("file",a),b}},preparePreviousImages:function(){var b=this;this.$el.find(".mediumInsert-images").each(function(){var c=a(this).parent();c.html('<div class="mediumInsert-placeholder" draggable="'+b.options.dragAndDrop+'">'+c.html()+"</div>")})},add:function(b,c){var d,e,f=this;return d=a('<input type="file">').click(),d.change(function(){e=this.files,f.uploadFiles(c,e,f)}),a.fn.mediumInsert.insert.deselect(),d},updateProgressBar:function(b){var c,d=a(".progress:first",this.$el);b.lengthComputable&&(c=b.loaded/b.total*100|0,d.attr("value",c),d.html(c))},uploadCompleted:function(b){var c,d=a(".progress:first",this.$el);d.attr("value",100),d.html(100),c=d.siblings(".uploading").find("img"),d.remove(),c.css("opacity",1),d.siblings(".uploading").removeClass("uploading"),this.options.uploadCompleteCallback(b),a.fn.mediumInsert.insert.$el.keyup()},uploadFiles:function(b,c,d){function e(a){j.before('<div class="uploading mediumInsert-images"><img style="opacity: 0.8;width:100%" data-attachment="" src="'+a.target.result+'" draggable="true" alt=""></div>')}for(var f=d.options.acceptedTypes,g=function(){var a=new XMLHttpRequest;return a.upload.onprogress=d.updateProgressBar,a},h=0;h<c.length;h++){var i=c[h];if(f[i.type]===!0){b.append('<progress style="display:none" class="progress" min="0" max="100" value="0">0</progress>');var j=a(".progress:first",this.$el);j.parent().parent().after("<p><br/></p>");var k=new FileReader;a(k).on("load",e),k.readAsDataURL(i),uploadPromise=a.ajax({type:"post",url:a.fn.mediumInsert.settings.addons.images.imagesUploadScript,xhr:g,cache:!1,contentType:!1,context:this,complete:function(a){d.uploadCompleted(a,b)},success:function(a){data=this.options.format(a),$img=j.siblings(".uploading").find("img"),$img.attr("src",data.imageSrc),$img.attr("data-attachment",data.attachmentId),this.setImageEvents(),$img.load(function(){$img.parent().mouseleave().mouseenter()}),d.options.uploadSuccessCallback(a)},error:function(a){d.options.uploadErrorCallback(a,b),$img=j.siblings(".uploading").find("img"),$img.detach()},processData:!1,data:this.options.formatData(i)}),d.options.onStartUpload(uploadPromise)}else d.options.unsupportedFileTypeCallback()}},setImageEvents:function(){this.$el.on("mouseenter",".mediumInsert-images",function(){var b,c,d=a("img",this);a.fn.mediumInsert.settings.enabled!==!1&&d.length>0&&(a(this).append('<a class="mediumInsert-imageRemove"></a>'),b=d.position().top+parseInt(d.css("margin-top"),10),c=d.position().left+d.width()-30,a(".mediumInsert-imageRemove",this).css({right:"auto",top:b,left:c}))}),this.$el.on("mouseleave",".mediumInsert-images",function(){a(".mediumInsert-imageRemove, .mediumInsert-imageResizeSmaller, .mediumInsert-imageResizeBigger",this).remove()}),this.$el.on("click",".mediumInsert-imageResizeSmaller",function(){a(this).parent().parent().parent().addClass("small"),a(this).parent().mouseleave().mouseleave(),a.fn.mediumInsert.insert.deselect()}),this.$el.on("click",".mediumInsert-imageResizeBigger",function(){a(this).parent().parent().parent().removeClass("small"),a(this).parent().mouseleave().mouseleave(),a.fn.mediumInsert.insert.deselect()}),this.$el.on("click",".mediumInsert-imageRemove",function(){a.fn.mediumInsert.settings.addons.images.onRemove(this),0===a(this).parent().siblings().length&&a(this).parent().parent().parent().removeClass("small"),a(this).parent().remove(),a.fn.mediumInsert.insert.deselect()})},setDragAndDropEvents:function(){var b,c,d=this,e=!1,f=!1;a(document).on("dragover","body",function(){a.fn.mediumInsert.settings.enabled!==!1&&a(this).addClass("hover")}),a(document).on("dragend","body",function(){a.fn.mediumInsert.settings.enabled!==!1&&a(this).removeClass("hover")}),this.$el.on("dragover",".mediumInsert",function(){a.fn.mediumInsert.settings.enabled!==!1&&(a(this).addClass("hover"),a(this).attr("contenteditable",!0))}),this.$el.on("dragleave",".mediumInsert",function(){a.fn.mediumInsert.settings.enabled!==!1&&(a(this).removeClass("hover"),a(this).attr("contenteditable",!1))}),this.$el.on("dragstart",".mediumInsert .mediumInsert-images img",function(){a.fn.mediumInsert.settings.enabled!==!1&&(b=a(this).parent().index(),c=a(this).parent().parent().parent().attr("id"))}),this.$el.on("dragend",".mediumInsert .mediumInsert-images img",function(b){a.fn.mediumInsert.settings.enabled!==!1&&e===!0&&(0===a(b.originalEvent.target.parentNode).siblings().length&&a(b.originalEvent.target.parentNode).parent().parent().removeClass("small"),a(b.originalEvent.target.parentNode).mouseleave(),a(b.originalEvent.target.parentNode).remove(),e=!1,f=!1)}),this.$el.on("dragover",".mediumInsert .mediumInsert-images img",function(b){a.fn.mediumInsert.settings.enabled!==!1&&b.preventDefault()}),this.$el.on("drop",".mediumInsert .mediumInsert-images img",function(){var d,e,g;if(a.fn.mediumInsert.settings.enabled!==!1){if(c!==a(this).parent().parent().parent().attr("id"))return f=!1,void(b=c=null);d=parseInt(b,10),e=a(this).parent().parent().find(".mediumInsert-images:nth-child("+(d+1)+")"),g=a(this).parent().index(),g>d?e.insertAfter(a(this).parent()):d>g&&e.insertBefore(a(this).parent()),e.mouseleave(),f=!0,b=null}}),this.$el.on("drop",".mediumInsert",function(b){var c;b.preventDefault(),a.fn.mediumInsert.settings.enabled!==!1&&(a(this).removeClass("hover"),a("body").removeClass("hover"),a(this).attr("contenteditable",!1),c=b.originalEvent.dataTransfer.files,c.length>0?d.uploadFiles(a(".mediumInsert-placeholder",this),c,d):f===!0?f=!1:(a(".mediumInsert-placeholder",this).append('<div class="mediumInsert-images">'+b.originalEvent.dataTransfer.getData("text/html")+"</div>"),a("meta",this).remove(),e=!0))})}})}(jQuery),function(a){a.fn.mediumInsert.registerAddon("maps",{init:function(){this.$el=a.fn.mediumInsert.insert.$el},insertButton:function(a){var b="Map";return"fontawesome"==a&&(b='<i class="fa fa-map-marker"></i>'),'<button data-addon="maps" data-action="add" class="medium-editor-action medium-editor-action-image mediumInsert-action">'+b+"</button>"},add:function(b){a.fn.mediumInsert.insert.deselect(),b.append('<div class="mediumInsert-maps">Map - Coming soon...</div>')}})}(jQuery),function(a){"use strict";a.fn.mediumInsert.registerAddon("embed",{init:function(b){b&&b.$el&&(this.$el=b.$el),this.options=a.extend(this.default,b)},"default":{supportedProviders:["youtube","vimeo"],unsupportedURL:function(a){console.error("un-supported url",a)},loadingCallback:a.noop,onSuccess:a.noop,onError:a.noop,onComplete:a.noop,embedlyKey:null},setInputboxEvents:function(){var b=this;this.$input.click(function(b){b.stopPropagation(),a.fn.mediumInsert.settings.editor.deactivateTextEditor()}),this.$input.keydown(function(a){(a.ctrlKey||a.metaKey)&&65===a.which&&(a.preventDefault(),this.select())}),this.$input.focus(function(b){b.stopPropagation(),a.fn.mediumInsert.settings.editor.deactivateTextEditor()}),this.$input.keyup(function(c){13===c.which&&(c.stopPropagation(),a(document.body).off("click",a.fn.mediumInsert.insert.hideMediumInput),b.isSupported(this.value)?b.getEmbedCode(this.value):(a(document.body).on("click",a.fn.mediumInsert.insert.hideMediumInput),b.options.unsupportedURL(this.value)))})},insertButton:function(a){var b="Embed";return"fontawesome"===a&&(b='<i class="fa fa-film"></i>'),'<button data-addon="embed" data-action="add" class="medium-editor-action medium-editor-action-embed mediumInsert-action">'+b+"</button>"},add:function(b,c){this.placeholder=c,a.fn.mediumInsert.insert.deselect(),this.showInputBox(b,this.placeholder)},showInputBox:function(b,c){b.stopPropagation();var d=a(".mediumInsert-embed-input-url");d.length>0&&d.parent().detach(),this.$mediumInsertEmbed=a('<div class="mediumInsert-embed medium-arrow-right"></div>'),this.$input=a('<input class="mediumInsert-embed-input-url mediumInsert-input" placeholder="Paste or type a video link">'),this.setInputboxEvents(),c.prepend(this.$mediumInsertEmbed.prepend(this.$input)),this.$input.focus()},isSupported:function(a){var b=!1;if(/\.(gif|jpg|jpeg|tiff|png)$/i.test(a))return!0;for(var c=this.options.supportedProviders,d=this.options.supportedProviders.length;d>=0;){if(-1!==a.toLowerCase().indexOf(c[d])){b=!0;break}d--}return b},cancel:function(){return this.promise?this.promise.reject([{error:!0,error_message:"abort"}]):void 0},getEmbedCode:function(b){var c=this,d=a(".mediumInsert-embed-input-url");d.prop("disabled",!0).addClass("loading"),this.options.loadingCallback(d),this.promise=a.embedly.extract([b],{key:this.options.embedlyKey}),this.promise.done(function(a){if(!a[0].error){if(d.parent().detach(),0!==c.placeholder.children().length){var b,e=c.placeholder.parent();e.prev("p").before("<p><br><p>"),c.$el.keyup(),b=e.prevAll(".mediumInsert").first(),c.placeholder=b.find(".mediumInsert-placeholder")}c.options.onSuccess(a[0],c.placeholder)}}),this.promise.always(function(b){a(document.body).on("click",a.fn.mediumInsert.insert.hideMediumInput),d.removeClass("loading"),b[0].error&&(d.prop("disabled",!1),d.focus(),c.options.onError(b[0])),c.options.onComplete(b[0])})}})}(jQuery);